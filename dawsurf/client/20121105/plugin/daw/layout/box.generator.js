(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","underscore","../element/device","./device.partitioner","lib/guardian"],function(b,c,d,e){var f;return f=function(){function b(){this._reset=a(this._reset,this),this._add_box=a(this._add_box,this),this.generate=a(this.generate,this),this.add_param=a(this.add_param,this),this.add_group=a(this.add_group,this),this.init=a(this.init,this)}return b.prototype._TINT_MAX=12,b.prototype.init=function(){return this._reset()},b.prototype.on_box_add=function(){},b.prototype.on_box_create=function(){},b.prototype.on_group_add=function(){},b.prototype.on_ready=function(){},b.prototype.add_group=function(a){var b=this;return this._device_uid!=null?assert(function(){return a.target_uid===b._device_uid}):this._device_uid=a.target_uid,a.name.length||(a.name="*"),this._groups[a.name]=this._groups_by_uid[a.uid]=c.extend(a,{params:[]})},b.prototype.add_param=function(a){return this._groups_by_uid[assert(function(){return a.target_uid})].params.push(a)},b.prototype.generate=function(a){var b,d,f,g,h,i,j=this;assert(function(){return a.uid===j._device_uid}),f=c.keys(this._groups),g=c.map(c.values(this._groups),function(a){return a.params.length}),d=e.partition(f,g);for(h=0,i=d.length;h<i;h++)b=d[h],c.defer(this._add_box,this._device_uid,this._groups,b,h,h===d.length-1);return this._reset()},b.prototype._add_box=function(a,b,e,f,g){var h,i,j,k,l,m,n,o=this;e.device_uid=a,e.group_uids=c.map(e.group_names,function(a){return b[a].uid}),e.group_tints=c.map(e.group_names,function(a,b){return(e.type==="wild"?b:f)%(1+o._TINT_MAX)}),e.groups=c.zip(e.group_uids,e.group_names,e.group_tints),e.tint=f,this.on_box_create(e),m=e.groups;for(k=0,l=m.length;k<l;k++)n=m[k],j=n[0],h=n[1],i=n[2],c.defer(this.on_group_add,{$box:e.$box,group_uid:j,group_params:b[h].params,group_tint:i});c.defer(this.on_box_add,{uid:a,$box:e.$box});if(g)return c.defer(this.on_ready,d.get_by_uid(a))},b.prototype._reset=function(){return this._device_uid=void 0,this._groups={},this._groups_by_uid={}},b}(),new f})}).call(this);