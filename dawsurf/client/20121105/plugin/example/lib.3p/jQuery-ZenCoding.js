/**
 * Copyright (c) 2010 Mike Kent
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */(function(a){function r(e,f,g,h){if(a.isPlainObject(e))var i=e.main;else{var i=e;e={main:i}}var j=i;h===undefined&&(h={});if(i.charAt(0)=="!"||a.isArray(f)){if(a.isArray(f))var k=i;else{var m=x(i,"!");m=m.substring(m.indexOf(":")+1,m.length-1);var k=z(i)}while(k.charAt(0)=="@")k=z("!for:!"+y(k,e));var n=e;n.main=k;var o=a();if(i.substring(0,5)=="!for:"||a.isArray(f)){if(!a.isArray(f)&&m.indexOf(":")>0){var p=m.substring(0,m.indexOf(":"));m=m.substr(m.indexOf(":")+1)}var q=a.isArray(f)?f:f[m],A=n.main;(a.isArray(q)||a.isPlainObject(q))&&a.map(q,function(b,c){n.main=A,p!==undefined&&(h[p]=c),a.isPlainObject(b)||(b={value:b});var d=r(n,b,g,h);o.length==0?o=d:a.each(d,function(a,b){o.push(b)})}),a.isArray(f)?i="":i=i.substr(m.length+6+k.length)}else if(i.substring(0,4)=="!if:"){var B=w("!"+m+"!",f,h);if(B!="undefined"||B!="false"||B!="")o=r(n,f,g,h);i=i.substr(m.length+5+k.length)}e.main=i}else if(i.charAt(0)=="("){var C=x(i,"(",")"),D=C.substring(1,C.length-1);i=i.substr(C.length);var n=e;n.main=D;var o=r(n,f,g,h)}else{var E=i.match(b),F=E[0];if(F.length==0)return"";if(F.indexOf("@")>=0){i=y(i,e);var n=e;return n.main=i,r(n,f,g,h)}F=w(F,f,h);var G=v(F);if(d.test(F))var H=d.exec(F)[1];var I=u(F,f),J=F.charAt(0)=="{"?"span":"div";i.charAt(0)!="#"&&i.charAt(0)!="."&&i.charAt(0)!="{"&&(J=c.exec(F)[1]);if(F.search(l)!=-1)var K=F.match(l)[1];I=a.extend(I,{id:H,"class":G,html:K});var o=a("<"+J+">",I);o.attr(I),o=t(F,o,g),o=s(F,o,f),i=i.substr(E[0].length),e.main=i}if(i.length>0){if(i.charAt(0)==">"){if(i.charAt(1)=="("){var A=x(i.substr(1),"(",")");i=i.substr(A.length+1)}else if(i.charAt(1)=="!"){var m=x(i.substr(1),"!"),k=z(i.substr(1)),A=m+k;i=i.substr(A.length+1)}else{var L=Math.max(i.indexOf("+"),i.length),A=i.substring(1,L);i=i.substr(L)}var n=e;n.main=A;var M=a(r(n,f,g,h));M.appendTo(o)}if(i.charAt(0)=="+"){var n=e;n.main=i.substr(1);var N=r(n,f,g,h);a.each(N,function(a,b){o.push(b)})}}var O=o;return O}function s(b,c,d){if(b.search(p)==0)return c;var e=b.match(p);if(e===null)return c;for(var f=0;f<e.length;f++){var g=q.exec(e[f]);g[3]===undefined?a(c).data(g[1],d[g[1]]):a(c).data(g[1],d[g[3]])}return c}function t(b,c,d){if(b.search(n)==0)return c;var e=b.match(n);if(e===null)return c;for(var f=0;f<e.length;f++){var g=o.exec(e[f]);if(g[2]===undefined)var h=d[g[1]];else var h=d[g[2]];a(c).bind(g[1],h)}return c}function u(a,b){if(a.search(i)==-1)return undefined;var c=a.match(i);c=c[0].match(j);var d={};for(var e=0;e<c.length;e++){var f=k.exec(c[e]);d[f[1]]="",f[3]!==undefined&&(d[f[1]]=w(f[3],b))}return d}function v(b){b=b.match(e)[0];if(b.search(f)==-1)return undefined;var c=b.match(f),d="";for(var h=0;h<c.length;h++)d+=" "+g.exec(c[h])[1];return a.trim(d)}function w(a,b,c){c===undefined&&(c={});var d=a;if(b===undefined)return d;while(m.test(d))d=d.replace(m,function(a,d){var e="";if(a.indexOf("!for:")>0||a.indexOf("!if:")>0)return a;a.charAt(0)=="!"?a=a.substring(1,a.length-1):(e=a.charAt(0),a=a.substring(2,a.length-1));var f=new Function("data","indexes","var r=undefined;with(data){try{r="+a+";}catch(e){}}"+"with(indexes){try{if(r===undefined)r="+a+";}catch(e){}}"+"return r;"),g=unescape(f(b,c));return e+g});return d=d.replace(/\\./g,function(a){return a.charAt(1)}),unescape(d)}function x(a,b,c,d){c===undefined&&(c=b);var e=1;d===undefined&&(d=a.charAt(0)==b?1:0);if(d==0)return;for(;d>0&&e<a.length;e++)a.charAt(e)==c&&a.charAt(e-1)!="\\"?d--:a.charAt(e)==b&&a.charAt(e-1)!="\\"&&d++;var f=a.substring(0,e);return f}function y(a,b){return a=a.replace(h,function(a){a=a.substr(1);var c=new Function("objs",'var r="";with(objs){try{r='+a+";"+"}catch(e){}}"+"return r;");return c(b,y)}),a}function z(a){if(a.substring(0,5)!="!for:"&&a.substring(0,4)!="!if:")return undefined;var c=x(a,"!");a=a.substr(c.length);if(a.charAt(0)=="(")return x(a,"(",")");var d=a.match(b)[0];a=a.substr(d.length);if(a.length==0||a.charAt(0)=="+")return d;if(a.charAt(0)==">"){var e="";return e=x(a.substr(1),"(",")",1),d+">"+e}return undefined}a.zc=a.zen=function(a,b){if(b!==undefined)var c=b.functions;var d=r(a,b,c);return d};var b=/([#\.\@]?[\w-]+|\[([(\w|\-)!?=:"']+(="([^"]|\\")+")? {0,})+\]|\~[\w$]+=[\w$]+|&[\w$]+(=[\w$]+)?|[#\.\@]?!([^!]|\\!)+!){0,}(\{([^\}]|\\\})+\})?/i,c=/(\w+)/i,d=/#((\-|[\w])+)/i,e=/((([#\.]?[\w-]+)?(\[([\w!]+(="([^"]|\\")+")? {0,})+\])?)+)/i,f=/(\.[\w-]+)/gi,g=/\.([\w-]+)/i,h=/(@[\w$_][\w$_\d]+)/i,i=/(\[([(\w|\-)!]+(="([^"]|\\")+")? {0,})+\])/i,j=/([(\w|\-)!]+(="([^"]|\\")+")?)/gi,k=/([(\w|\-)!]+)(="(([^"]|\\")+)")?/i,l=/\{(([^\}]|\\\})+)\}/i,m=/(?:([^\\]|^))!([^!]|\\!)+!/gim,n=/\~[\w$]+(=[\w$]+)?/gi,o=/\~([\w$]+)=([\w$]+)/i,p=/&[\w$]+(=[\w$]+)?/gi,q=/&([\w$]+)(=([\w$]+))?/i})(jQuery);