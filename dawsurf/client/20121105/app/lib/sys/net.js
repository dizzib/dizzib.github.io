(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["underscore","lib/platform/features","lib/platform/net","lib/guardian","lib/datatype.extension/string"],function(b,c,d){var e;return e=function(){function e(){this._trigger_throttled=a(this._trigger_throttled,this),this._trigger=a(this._trigger,this),this._init=a(this._init,this),this._get_no_connect_msg=a(this._get_no_connect_msg,this),this.trigger=a(this.trigger,this),this.stop=a(this.stop,this),this.start=a(this.start,this)}return e.prototype._THROTTLE_FREQ_HZ=20,e.prototype._WS_STATE_CONNECTING=0,e.prototype._WS_STATE_OPEN=1,e.prototype._WS_STATE_CLOSING=2,e.prototype._WS_STATE_CLOSED=3,e.prototype._ws=void 0,e.prototype._ws_state_trailing=void 0,e.prototype.on_connect=function(){},e.prototype.on_command=function(){},e.prototype.on_disconnect=function(){},e.prototype.on_error=function(){},e.prototype.on_trigger=function(){},e.prototype.start=function(a){var b,e,f=this;if(!c.websockets){this.on_error({message:"Cannot connect because web sockets are not supported. Please upgrade your browser."});return}try{return e=["ws://"+assert(function(){return a!=null?a.server:void 0})+":"+assert(function(){return a!=null?a.port:void 0})+"/websession",""],this._url=e[0],b=e[1],this._ws=assert(function(){return d.create_websocket(f._url)}),this._init()}catch(g){return this.on_error({message:this._get_no_connect_msg(" "+g.message)})}},e.prototype.stop=function(){var a=this;assert(function(){var b;return((b=a._ws)!=null?b.readyState:void 0)===a._WS_STATE_OPEN});try{return this._ws.close()}catch(b){return this.on_error({message:"Error on socket close: "+b.message})}},e.prototype.trigger=function(a){return this._trigger_throttled(a)},e.prototype._get_no_connect_msg=function(a){return"Unable to connect to "+this._url+"."+a},e.prototype._init=function(){var a=this;return this._ws_state_trailing=this._WS_STATE_CLOSED,this._ws.onerror=function(b){var c;return c=(b!=null?b.reason:void 0)?" "+b.reason:(b!=null?b.message:void 0)?" "+b.message:"",a.on_error({message:"A network error occurred."+c})},this._ws.onopen=function(){return assert(function(){return a._ws.readyState===a._WS_STATE_OPEN}),a.on_connect({message:"Connected!"}),a._ws_state_trailing=a._ws.readyState},this._ws.onmessage=function(b){return a.on_command(a._unpack(b.data))},this._ws.onclose=function(b){var c;return assert(function(){return a._ws.readyState===a._WS_STATE_CLOSED}),c=(b!=null?b.reason:void 0)?" "+b.reason:"",a._ws_state_trailing===a._WS_STATE_OPEN?a.on_disconnect({message:"Disconnected."+c}):a.on_error({message:a._get_no_connect_msg(c)}),a._ws_state_trailing=a._ws.readyState}},e.prototype._pack=function(a){var b,c;return c=a[0],b=a[1],assert(function(){return c!=null&&c.length>0}),(""+c+" "+(b!=null?JSON.stringify(b):"")).trim_lr()},e.prototype._trigger=function(a){var b=this;try{return assert(function(){return b._ws}).send(this._pack(a)),this.on_trigger(a)}catch(c){return this.on_error({message:"Unable to send packet "+a+" to "+url+". "+c.message})}},e.prototype._trigger_throttled=function(a){return b.throttle(this._trigger(a),1e3/this._THROTTLE_FREQ_HZ,!0)},e.prototype._unpack=function(a){var b;assert(function(){return a!=null&&a.length>0});if((b=a.split(/\s(.+)/)).length!==3)throw"unable to unpack due to unexpected message format: "+a;return[b[0],JSON.parse(b[1])]},e}(),new e})}).call(this);