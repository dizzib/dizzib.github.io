(function(e){e(function(){var e,n,t,r,i,o,u,f;f=Object.freeze||function(e){return e};e=Array.prototype;n=e.unshift;t=e.push;i=e.slice;o=Array.isArray||function(e){return Object.prototype.toString.call(e)=="[object Array]"};u=Object.defineProperty||function(e,n,t){e[n]=t.value};r={before:w,around:false};r.on=r.afterReturning=r.afterThrowing=r.after=b;function a(e,n){var t,r,o;this.target=e;this.func=n;this.aspects={};t=this.orig=e[n];r=this;o=this.advised=function(){var e,u,f,a,c,s;if(this instanceof o){if(!Object.create){throw new Error("An ES5 environment is required for advice on constructors")}e=Object.create(t.prototype);f=function(n){return A(t,e,n)}}else{e=this;f=function(n){return t.apply(e,n)}}u=i.call(arguments);c="afterReturning";r._callSimpleAdvice("before",e,u);try{a=r._callAroundAdvice(e,n,u,v)}catch(l){a=s=l;c="afterThrowing"}u=[a];p(c,u);p("after",u);if(s){throw s}return a;function v(n){var t=f(n);r._callSimpleAdvice("on",e,n);return t}function p(n,t){r._callSimpleAdvice(n,e,t)}};u(o,"_advisor",{value:r})}a.prototype={_callSimpleAdvice:function(e,n,t){var i,o;o=this.aspects[e];if(!o){return}i=r[e];i(this.aspects[e],function(e){var r=e.advice;r&&r.apply(n,t)})},_callAroundAdvice:function(e,n,t,r){var o,u;u=this.aspects.around;o=u?u.length:0;function a(e,n){return e<0?r(n):c(u[e].advice,e,n)}function c(t,r,o){var u,c;u=0;c=f({target:e,method:n,args:o,proceed:l,proceedApply:v,proceedCount:s});return t.call(e,c);function s(){return u}function l(){return p(arguments.length>0?i.call(arguments):o)}function v(e){return p(e||o)}function p(e){u++;return a(r-1,e)}}return a(o-1,t)},add:function(e){var n,t;n=this;t=n.aspects;y(t,e);return{remove:function(){var r=m(t,e);if(!r){n.remove()}}}},remove:function(){delete this.advised._advisor;this.target[this.func]=this.orig}};a.get=function(e,n){if(!(n in e)){return}var t,r;r=e[n];if(typeof r!=="function"){throw new Error("Advice can only be applied to functions: "+n)}t=r._advisor;if(!t){t=new a(e,n);e[n]=t.advised}return t};return{add:c,before:g("before"),around:g("around"),on:g("on"),afterReturning:g("afterReturning"),afterThrowing:g("afterThrowing"),after:g("after")};function c(e,n,t){var r,i;if(arguments.length<3){return s(e,n)}else{e=h(e);if(o(n)){i=v(e,n,t)}else{r=typeof n;if(r==="string"){if(typeof e[n]==="function"){i=l(e,n,t)}}else if(r==="function"){i=v(e,n(e),t)}else{i=p(e,n,t)}}return i}}function s(e,n){var t,r;t=e.name||"_";r={};r[t]=e;l(r,t,n);return r[t]}function l(e,n,t){var r=a.get(e,n);return r&&r.add(t)}function v(e,n,t){var r,i,o,u;r=[];u=0;while(o=n[u++]){i=l(e,o,t);i&&r.push(i)}return d(r)}function p(e,n,t){var r=[];for(var i in e){if(typeof e[i]=="function"&&n.test(i)){r.push(l(e,i,t))}}return d(r)}function d(e){return{remove:function(){for(var n=e.length-1;n>=0;--n){e[n].remove()}}}}function h(e){return typeof e=="function"?e.prototype||e:e}function g(e){return function(n,t,r){var i={};if(arguments.length===2){i[e]=t;return c(n,i)}else{i[e]=r;return c(n,t,i)}}}function y(e,n){var t,i,o;for(t in r){i=n[t];if(i){o=e[t];if(!o){e[t]=o=[]}o.push({aspect:n,advice:i})}}}function m(e,n){var t,i,o;o=0;for(t in r){i=e[t];if(i){o+=i.length;for(var u=i.length-1;u>=0;--u){if(i[u].aspect===n){i.splice(u,1);--o;break}}}}return o}function A(e,n,t){try{Object.defineProperty(n,"constructor",{value:e,enumerable:false})}catch(r){}e.apply(n,t);return n}function b(e,n){for(var t=0,r=e.length;t<r;t++){n(e[t])}}function w(e,n){for(var t=e.length-1;t>=0;--t){n(e[t])}}})})(typeof define=="function"&&define.amd?define:function(e){module.exports=e()});