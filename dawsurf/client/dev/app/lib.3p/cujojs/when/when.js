(function(n){"use strict";n(["module"],function(){var n,e,r;t.defer=s;t.resolve=u;t.reject=o;t.join=v;t.all=p;t.some=h;t.any=l;t.map=g;t.reduce=m;t.chain=y;t.isPromise=a;function t(n,e,r,t){return u(n).then(e,r,t)}function u(n){var e,r;if(n instanceof i){e=n}else{if(a(n)&&typeof n.valueOf==="function"){n=n.valueOf()}if(a(n)){r=s();n.then(r.resolve,r.reject,r.progress);e=r.promise}else{e=f(n)}}return e}function o(n){return t(n,function(n){return c(n)})}function i(n){this.then=n}i.prototype={always:function(n,e){return this.then(n,n,e)},otherwise:function(n){return this.then(r,n)}};function f(n){var e=new i(function(e){try{return u(e?e(n):n)}catch(r){return c(r)}});return e}function c(n){var e=new i(function(e,r){try{return r?u(r(n)):c(n)}catch(t){return c(t)}});return e}function s(){var n,e,t,o,f,a,h;e=new i(l);n={then:l,resolve:p,reject:v,progress:g,promise:e,resolver:{resolve:p,reject:v,progress:g}};t=[];o=[];f=function(n,e,r){var u,i;u=s();i=r?function(n){try{u.progress(r(n))}catch(e){u.progress(e)}}:u.progress;t.push(function(r){r.then(n,e).then(u.resolve,u.reject,i)});o.push(i);return u.promise};a=function(n){w(o,n);return n};h=function(n){n=u(n);f=n.then;h=u;a=d;w(t,n);o=t=r;return n};return n;function l(n,e,r){return f(n,e,r)}function p(n){return h(n)}function v(n){return h(c(n))}function g(n){return a(n)}}function a(n){return n&&typeof n.then==="function"}function h(n,e,r,u,o){j(2,arguments);return t(n,function(n){var i,f,c,a,h,l,p,v,g,m;g=n.length>>>0;i=Math.max(0,Math.min(e,g));c=[];f=g-i+1;a=[];h=s();if(!i){h.resolve(c)}else{v=h.progress;p=function(n){a.push(n);if(!--f){l=p=d;h.reject(a)}};l=function(n){c.push(n);if(!--i){l=p=d;h.resolve(c)}};for(m=0;m<g;++m){if(m in n){t(n[m],w,y,v)}}}return h.then(r,u,o);function y(n){p(n)}function w(n){l(n)}})}function l(n,e,r,t){function u(n){return e?e(n[0]):n[0]}return h(n,1,u,r,t)}function p(n,e,r,t){j(1,arguments);return g(n,b).then(e,r,t)}function v(){return g(arguments,b)}function g(n,e){return t(n,function(n){var r,u,o,i,f,c,a;o=u=n.length>>>0;r=[];a=s();if(!o){a.resolve(r)}else{f=a.reject;i=function h(n,u){t(n,e).then(function(n){r[u]=n;if(!--o){a.resolve(r)}},f)};for(c=0;c<u;c++){if(c in n){i(n[c],c)}else{--o}}}return a.promise})}function m(r,u){var o=e.call(arguments,1);return t(r,function(e){var r;r=e.length;o[0]=function(n,e,o){return t(n,function(n){return t(e,function(e){return u(n,e,o,r)})})};return n.apply(e,o)})}function y(n,e,r){var u=arguments.length>2;return t(n,function(n){return e.resolve(u?r:n)},e.reject,e.progress)}function w(n,e){var r,t=0;while(r=n[t++]){r(e)}}function j(n,e){var r,t=e.length;while(t>n){r=e[--t];if(r!=null&&typeof r!="function"){throw new Error("arg "+t+" must be a function")}}}function d(){}e=[].slice;n=[].reduce||function(n){var e,r,t,u,o;o=0;e=Object(this);u=e.length>>>0;r=arguments;if(r.length<=1){for(;;){if(o in e){t=e[o++];break}if(++o>=u){throw new TypeError}}}else{t=r[1]}for(;o<u;++o){if(o in e){t=n(t,e[o],o,e)}}return t};function b(n){return n}return t})})(typeof define=="function"&&define.amd?define:function(n,e){typeof exports==="object"?module.exports=e():this.when=e()});