(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","knockout","underscore","model/servers","lib/guardian","lib/platform/features","lib/regex.pattern","text!./servers.html","css!./servers"],function(e,r,i,s,n,o,_,a){var l;return new(l=function(){function l(){this._start_edit=t(this._start_edit,this);this._server_connect=t(this._server_connect,this);this._server_edit_start=t(this._server_edit_start,this);this._server_edit_save=t(this._server_edit_save,this);this._server_edit_cancel=t(this._server_edit_cancel,this);this._server_delete=t(this._server_delete,this);this._server_add=t(this._server_add,this);this._get_validator_field=t(this._get_validator_field,this);this._auto_connect__on_click=t(this._auto_connect__on_click,this);this._init_validator=t(this._init_validator,this);this.init=t(this.init,this)}l.prototype.init=function(){var t;t=e("#servers").append(a);n.assert(function(){return t.length===1});this._$editor=e("#server-editor");this._init_validator();return r.applyBindings(this,t[0])};l.prototype.on_activate=function(){};l.prototype.on_alert=function(){};l.prototype._is_connectible=o.websockets;l.prototype._editor_server=r.observable();l.prototype._editor_message=r.observable();l.prototype._init_validator=function(){var t;t=[this._get_validator_field("id","required|max_length[30]"),this._get_validator_field("server","required|max_length[30]|callback_endpoint"),this._get_validator_field("port","required|integer|greater_than[-1]|less_than[65536]")];this._validator=new FormValidator("server-editor",t,this._on_validate);this._validator.registerCallback("endpoint",function(t){return new RegExp(_.ENDPOINT).test(t)});return this._validator.setMessage("endpoint","Please enter a valid server name or IP address")};l.prototype._auto_connect__on_click=function(t,e){this.auto_connect_id(e.target.checked?t.id():null);return true};l.prototype._get_label=function(t){return e("label[for='"+t+"']").html()};l.prototype._get_validator_field=function(t,e){return{name:t,display:this._get_label(t),rules:e}};l.prototype._on_validate=function(t){if(!t.length){return}return alert(i.pluck(t,"message").join("\n"))};l.prototype._server_add=function(){return this._start_edit(s.create(),true)};l.prototype._server_delete=function(){var t,r,i=this;r=this._editor_server();return t=e("<div/>").html("Are you sure ?").dialog({buttons:{Yes:function(){s.remove(r);s.save();i.on_alert({message:"Deleted "+r.id()});i._editor_server(null);return t.dialog("close")},No:function(){return t.dialog("close")}},closeOnEscape:true,dialogClass:"dialog-confirm",modal:true,resizable:false,title:"Delete "+r.id(),width:300})};l.prototype._server_edit_cancel=function(){s.load();return this._editor_server(null)};l.prototype._server_edit_save=function(){var t;if(this._validator.errors.length){return}t=this._editor_server();if(t.is_new){delete t.is_new;s.add(t)}s.save();return this._editor_server(null)};l.prototype._server_edit_start=function(t){return this._start_edit(t,false)};l.prototype._server_connect=function(t){return this.on_activate(t)};l.prototype._start_edit=function(t,e){this._$editor.dialog("option","title",""+(e?"Add":"Edit")+" Server Configuration");return this._editor_server(i.extend(t,{is_new:e}))};return l}())})}).call(this);