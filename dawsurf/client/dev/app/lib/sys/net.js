(function(){var t=function(t,r){return function(){return t.apply(r,arguments)}};define(["underscore","lib/guardian","lib/platform/features","lib/platform/net","lib/datatype.extension/string"],function(r,e,n,o){var s;return new(s=function(){function s(){this._trigger_throttled=t(this._trigger_throttled,this);this._trigger=t(this._trigger,this);this._init=t(this._init,this);this._get_no_connect_msg=t(this._get_no_connect_msg,this);this.trigger=t(this.trigger,this);this.stop=t(this.stop,this);this.start=t(this.start,this)}s.prototype._THROTTLE_FREQ_HZ=20;s.prototype._WS_STATE_CONNECTING=0;s.prototype._WS_STATE_OPEN=1;s.prototype._WS_STATE_CLOSING=2;s.prototype._WS_STATE_CLOSED=3;s.prototype._ws=void 0;s.prototype._ws_state_trailing=void 0;s.prototype.on_connect=function(){};s.prototype.on_command=function(){};s.prototype.on_disconnect=function(){};s.prototype.on_error=function(){};s.prototype.on_trigger=function(){};s.prototype.start=function(t){var r,s,i=this;if(!n.websockets){this.on_error({message:"Cannot connect because web sockets are not supported. Please upgrade your browser."});return}try{s=["ws://"+e.assert(function(){return t!=null?t.server:void 0})+":"+e.assert(function(){return t!=null?t.port:void 0})+"/websession",""],this._url=s[0],r=s[1];this._ws=e.assert(function(){return o.create_websocket(i._url)});return this._init()}catch(_){return this.on_error({message:this._get_no_connect_msg(" "+_.message)})}};s.prototype.stop=function(){var t=this;e.assert(function(){var r;return((r=t._ws)!=null?r.readyState:void 0)===t._WS_STATE_OPEN});try{return this._ws.close()}catch(r){return this.on_error({message:"Error on socket close: "+r.message})}};s.prototype.trigger=function(t){return this._trigger_throttled(t)};s.prototype._get_no_connect_msg=function(t){return"Unable to connect to "+this._url+"."+t};s.prototype._init=function(){var t=this;this._ws_state_trailing=this._WS_STATE_CLOSED;this._ws.onerror=function(r){var e;e=(r!=null?r.reason:void 0)?" "+r.reason:(r!=null?r.message:void 0)?" "+r.message:"";return t.on_error({message:"A network error occurred."+e})};this._ws.onopen=function(){e.assert(function(){return t._ws.readyState===t._WS_STATE_OPEN});t.on_connect({message:"Connected!"});return t._ws_state_trailing=t._ws.readyState};this._ws.onmessage=function(r){return t.on_command(t._unpack(r.data))};return this._ws.onclose=function(r){var n;e.assert(function(){return t._ws.readyState===t._WS_STATE_CLOSED});n=(r!=null?r.reason:void 0)?" "+r.reason:"";if(t._ws_state_trailing===t._WS_STATE_OPEN){t.on_disconnect({message:"Disconnected."+n})}else{t.on_error({message:t._get_no_connect_msg(n)})}return t._ws_state_trailing=t._ws.readyState}};s.prototype._pack=function(t){var r,n;n=t[0],r=t[1];e.assert(function(){return n!=null&&n.length>0});return(""+n+" "+(r!=null?JSON.stringify(r):"")).trim_lr()};s.prototype._trigger=function(t){var r=this;e.assert(function(){return r._ws});try{this._ws.send(this._pack(t));return this.on_trigger(t)}catch(n){return this.on_error({message:"Unable to send packet "+t+" to "+this._url+". "+n.message})}};s.prototype._trigger_throttled=function(t){return r.throttle(this._trigger(t),1e3/this._THROTTLE_FREQ_HZ,true)};s.prototype._unpack=function(t){var r;e.assert(function(){return t!=null&&t.length>0});if((r=t.split(/\s(.+)/)).length!==3){throw"unable to unpack due to unexpected message format: "+t}return[r[0],JSON.parse(r[1])]};return s}())})}).call(this);