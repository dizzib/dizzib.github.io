(function(){var t=function(t,i){return function(){return t.apply(i,arguments)}};define(["jquery","underscore","lib/guardian","../element/device","./device.partitioner"],function(i,r,e,n,o){var u;return new(u=function(){function i(){this._reset=t(this._reset,this);this._add_box=t(this._add_box,this);this.generate=t(this.generate,this);this.add_param=t(this.add_param,this);this.add_group=t(this.add_group,this);this.init=t(this.init,this)}i.prototype._TINT_MAX=12;i.prototype.init=function(){return this._reset()};i.prototype.on_box_add=function(){};i.prototype.on_box_create=function(){};i.prototype.on_group_add=function(){};i.prototype.on_ready=function(){};i.prototype.add_group=function(t){var i=this;if(this._device_uid!=null){e.assert(function(){return t.target_uid===i._device_uid})}else{this._device_uid=t.target_uid}return this._groups[t.name]=this._groups_by_uid[t.uid]=r.extend(t,{params:[]})};i.prototype.add_param=function(t){return this._groups_by_uid[e.assert(function(){return t.target_uid})].params.push(t)};i.prototype.generate=function(t){var i,n,u,s,_,d,p,a=this;e.assert(function(){return t.uid===a._device_uid});u=r.keys(this._groups);s=r.map(r.values(this._groups),function(t){return t.params.length});n=o.partition(u,s);for(_=d=0,p=n.length;d<p;_=++d){i=n[_];r.defer(this._add_box,this._device_uid,this._groups,i,_,_===n.length-1)}return this._reset()};i.prototype._add_box=function(t,i,e,o,u){var s,_,d,p,a,h,g,c=this;e.device_uid=t;e.group_uids=r.map(e.group_names,function(t){return i[t].uid});e.group_tints=r.map(e.group_names,function(t,i){return(e.type==="wild"?i:o)%(1+c._TINT_MAX)});e.groups=r.zip(e.group_uids,e.group_names,e.group_tints);e.tint=o;this.on_box_create(e);h=e.groups;for(p=0,a=h.length;p<a;p++){g=h[p],d=g[0],s=g[1],_=g[2];r.defer(this.on_group_add,{$box:e.$box,group_uid:d,group_params:i[s].params,group_tint:_})}r.defer(this.on_box_add,{uid:t,$box:e.$box});if(u){return r.defer(this.on_ready,n.get_by_uid(t))}};i.prototype._reset=function(){this._device_uid=void 0;this._groups={};return this._groups_by_uid={}};return i}())})}).call(this);