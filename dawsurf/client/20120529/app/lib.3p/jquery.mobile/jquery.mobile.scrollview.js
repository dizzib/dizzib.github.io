/*
* jQuery Mobile Framework : scrollview plugin
* Copyright (c) 2010 Adobe Systems Incorporated - Kin Blas (jblas@adobe.com)
* Dual licensed under the MIT (MIT-LICENSE.txt) and GPL (GPL-LICENSE.txt) licenses.
* Note: Code is in draft form and is subject to change 
*/(function(a,b,c,d){function e(a,b,c){var d="translate3d("+b+","+c+", 0px)";a.css({"-moz-transform":d,"-webkit-transform":d,transform:d})}function f(b){this.options=a.extend({},b),this.easing="easeOutQuad",this.reset()}function h(){return(new Date).getTime()}jQuery.widget("mobile.scrollview",jQuery.mobile.widget,{options:{fps:60,direction:null,scrollDuration:2e3,overshootDuration:250,snapbackDuration:500,moveThreshold:10,moveIntervalThreshold:150,scrollMethod:"translate",startEventName:"scrollstart",updateEventName:"scrollupdate",stopEventName:"scrollstop",eventType:a.support.touch?"touch":"mouse",showScrollBars:!0,pagingEnabled:!1,delayedClickSelector:"a,input,textarea,select,button,.ui-btn",delayedClickEnabled:!1},_makePositioned:function(a){a.css("position")=="static"&&a.css("position","relative")},_create:function(){this._$clip=a(this.element).addClass("ui-scrollview-clip");var b=this._$clip.children();b.length>1&&(b=this._$clip.wrapInner("<div></div>").children()),this._$view=b.addClass("ui-scrollview-view"),this._$clip.css("overflow",this.options.scrollMethod==="scroll"?"scroll":"hidden"),this._makePositioned(this._$clip),this._$view.css("overflow","hidden"),this.options.showScrollBars=this.options.scrollMethod==="scroll"?!1:this.options.showScrollBars,this._makePositioned(this._$view),this._$view.css({left:0,top:0}),this._sx=0,this._sy=0;var c=this.options.direction;this._hTracker=c!=="y"?new f(this.options):null,this._vTracker=c!=="x"?new f(this.options):null,this._timerInterval=1e3/this.options.fps,this._timerID=0;var d=this;this._timerCB=function(){d._handleMomentumScroll()},this._addBehaviors()},_startMScroll:function(a,b){this._stopMScroll(),this._showScrollBars();var c=!1,d=this.options.scrollDuration;this._$clip.trigger(this.options.startEventName);var e=this._hTracker;if(e){var f=this._$clip.width(),g=this._$view.width();e.start(this._sx,a,d,g>f?-(g-f):0,0),c=!e.done()}var h=this._vTracker;if(h){var f=this._$clip.height(),g=this._$view.height();h.start(this._sy,b,d,g>f?-(g-f):0,0),c=c||!h.done()}c?this._timerID=setTimeout(this._timerCB,this._timerInterval):this._stopMScroll()},_stopMScroll:function(){this._timerID&&(this._$clip.trigger(this.options.stopEventName),clearTimeout(this._timerID)),this._timerID=0,this._vTracker&&this._vTracker.reset(),this._hTracker&&this._hTracker.reset(),this._hideScrollBars()},_handleMomentumScroll:function(){var a=!1,b=this._$view,c=0,d=0,e=this._vTracker;e&&(e.update(),d=e.getPosition(),a=!e.done());var f=this._hTracker;f&&(f.update(),c=f.getPosition(),a=a||!f.done()),this._setScrollPosition(c,d),this._$clip.trigger(this.options.updateEventName,[{x:c,y:d}]),a?this._timerID=setTimeout(this._timerCB,this._timerInterval):this._stopMScroll()},_setScrollPosition:function(a,b){this._sx=a,this._sy=b;var c=this._$view,d=this.options.scrollMethod;switch(d){case"translate":e(c,a+"px",b+"px");break;case"position":c.css({left:a+"px",top:b+"px"});break;case"scroll":var f=this._$clip[0];f.scrollLeft=-a,f.scrollTop=-b}var g=this._$vScrollBar,h=this._$hScrollBar;if(g){var i=g.find(".ui-scrollbar-thumb");d==="translate"?e(i,"0px",-b/c.height()*i.parent().height()+"px"):i.css("top",-b/c.height()*100+"%")}if(h){var i=h.find(".ui-scrollbar-thumb");d==="translate"?e(i,-a/c.width()*i.parent().width()+"px","0px"):i.css("left",-a/c.width()*100+"%")}},scrollTo:function(b,c,d){this._stopMScroll();if(!d)return this._setScrollPosition(b,c);b=-b,c=-c;var e=this,f=h(),g=a.easing.easeOutQuad,i=this._sx,j=this._sy,k=b-i,l=c-j,m=function(){var a=h()-f;if(a>=d)e._timerID=0,e._setScrollPosition(b,c);else{var n=g(a/d,a,0,1,d);e._setScrollPosition(i+k*n,j+l*n),e._timerID=setTimeout(m,e._timerInterval)}};this._timerID=setTimeout(m,this._timerInterval)},getScrollPosition:function(){return{x:-this._sx,y:-this._sy}},_getScrollHierarchy:function(){var b=[];return this._$clip.parents(".ui-scrollview-clip").each(function(){var c=a(this).jqmData("scrollview");c&&b.unshift(c)}),b},_getAncestorByDirection:function(a){var b=this._getScrollHierarchy(),c=b.length;while(0<c--){var d=b[c],e=d.options.direction;if(!e||e==a)return d}return null},_handleDragStart:function(b,c,d){a.each(this._getScrollHierarchy(),function(a,b){b._stopMScroll()}),this._stopMScroll();var e=this._$clip,f=this._$view;this.options.delayedClickEnabled&&(this._$clickEle=a(b.target).closest(this.options.delayedClickSelector)),this._lastX=c,this._lastY=d,this._doSnapBackX=!1,this._doSnapBackY=!1,this._speedX=0,this._speedY=0,this._directionLock="",this._didDrag=!1;if(this._hTracker){var g=parseInt(e.css("width"),10),h=parseInt(f.css("width"),10);this._maxX=g-h,this._maxX>0&&(this._maxX=0),this._$hScrollBar&&this._$hScrollBar.find(".ui-scrollbar-thumb").css("width",g>=h?"100%":Math.floor(g/h*100)+"%")}if(this._vTracker){var i=parseInt(e.css("height"),10),j=parseInt(f.css("height"),10);this._maxY=i-j,this._maxY>0&&(this._maxY=0),this._$vScrollBar&&this._$vScrollBar.find(".ui-scrollbar-thumb").css("height",i>=j?"100%":Math.floor(i/j*100)+"%")}var k=this.options.direction;this._pageDelta=0,this._pageSize=0,this._pagePos=0,this.options.pagingEnabled&&(k==="x"||k==="y")&&(this._pageSize=k==="x"?g:i,this._pagePos=k==="x"?this._sx:this._sy,this._pagePos-=this._pagePos%this._pageSize),this._lastMove=0,this._enableTracking(),(this.options.eventType=="mouse"||this.options.delayedClickEnabled)&&b.preventDefault(),b.stopPropagation()},_propagateDragMove:function(a,b,c,d,e){this._hideScrollBars(),this._disableTracking(),a._handleDragStart(b,c,d),a._directionLock=e,a._didDrag=this._didDrag},_handleDragMove:function(a,b,c){this._lastMove=h();var d=this._$view,e=b-this._lastX,f=c-this._lastY,g=this.options.direction;if(!this._directionLock){var i=Math.abs(e),j=Math.abs(f),k=this.options.moveThreshold;if(i<k&&j<k)return!1;var l=null,m=0;i<j&&i/j<.5?l="y":i>j&&j/i<.5&&(l="x");if(g&&l&&g!=l){var n=this._getAncestorByDirection(l);if(n)return this._propagateDragMove(n,a,b,c,l),!1}this._directionLock=g?g:l?l:"none"}var o=this._sx,p=this._sy;if(this._directionLock!=="y"&&this._hTracker){var i=this._sx;this._speedX=e,o=i+e,this._doSnapBackX=!1;if(o>0||o<this._maxX){if(this._directionLock==="x"){var n=this._getAncestorByDirection("x");if(n)return this._setScrollPosition(o>0?0:this._maxX,p),this._propagateDragMove(n,a,b,c,l),!1}o=i+e/2,this._doSnapBackX=!0}}if(this._directionLock!=="x"&&this._vTracker){var j=this._sy;this._speedY=f,p=j+f,this._doSnapBackY=!1;if(p>0||p<this._maxY){if(this._directionLock==="y"){var n=this._getAncestorByDirection("y");if(n)return this._setScrollPosition(o,p>0?0:this._maxY),this._propagateDragMove(n,a,b,c,l),!1}p=j+f/2,this._doSnapBackY=!0}}if(this.options.pagingEnabled&&(g==="x"||g==="y"))if(this._doSnapBackX||this._doSnapBackY)this._pageDelta=0;else{var q=this._pagePos,r=g==="x"?o:p,s=g==="x"?e:f;this._pageDelta=q>r&&s<0?this._pageSize:q<r&&s>0?-this._pageSize:0}return this._didDrag=!0,this._lastX=b,this._lastY=c,this._setScrollPosition(o,p),this._showScrollBars(),!1},_handleDragStop:function(a){var b=this._lastMove,c=h(),e=b&&c-b<=this.options.moveIntervalThreshold,f=this._hTracker&&this._speedX&&e?this._speedX:this._doSnapBackX?1:0,g=this._vTracker&&this._speedY&&e?this._speedY:this._doSnapBackY?1:0,i=this.options.direction;if(this.options.pagingEnabled&&(i==="x"||i==="y")&&!this._doSnapBackX&&!this._doSnapBackY){var j=this._sx,k=this._sy;i==="x"?j=-this._pagePos+this._pageDelta:k=-this._pagePos+this._pageDelta,this.scrollTo(j,k,this.options.snapbackDuration)}else f||g?this._startMScroll(f,g):this._hideScrollBars();return this._disableTracking(),!this._didDrag&&this.options.delayedClickEnabled&&this._$clickEle.length&&this._$clickEle.trigger("mousedown").trigger("mouseup").trigger("click"),this._didDrag?!1:d},_enableTracking:function(){a(c).bind(this._dragMoveEvt,this._dragMoveCB),a(c).bind(this._dragStopEvt,this._dragStopCB)},_disableTracking:function(){a(c).unbind(this._dragMoveEvt,this._dragMoveCB),a(c).unbind(this._dragStopEvt,this._dragStopCB)},_showScrollBars:function(){var a="ui-scrollbar-visible";this._$vScrollBar&&this._$vScrollBar.addClass(a),this._$hScrollBar&&this._$hScrollBar.addClass(a)},_hideScrollBars:function(){var a="ui-scrollbar-visible";this._$vScrollBar&&this._$vScrollBar.removeClass(a),this._$hScrollBar&&this._$hScrollBar.removeClass(a)},_addBehaviors:function(){var a=this;this.options.eventType==="mouse"?(this._dragStartEvt="mousedown",this._dragStartCB=function(b){return a._handleDragStart(b,b.clientX,b.clientY)},this._dragMoveEvt="mousemove",this._dragMoveCB=function(b){return a._handleDragMove(b,b.clientX,b.clientY)},this._dragStopEvt="mouseup",this._dragStopCB=function(b){return a._handleDragStop(b)}):(this._dragStartEvt="touchstart",this._dragStartCB=function(b){var c=b.originalEvent.targetTouches[0];return a._handleDragStart(b,c.pageX,c.pageY)},this._dragMoveEvt="touchmove",this._dragMoveCB=function(b){var c=b.originalEvent.targetTouches[0];return a._handleDragMove(b,c.pageX,c.pageY)},this._dragStopEvt="touchend",this._dragStopCB=function(b){return a._handleDragStop(b)}),this._$view.bind(this._dragStartEvt,this._dragStartCB);if(this.options.showScrollBars){var b=this._$clip,c='<div class="ui-scrollbar ui-scrollbar-',d='"><div class="ui-scrollbar-track"><div class="ui-scrollbar-thumb"></div></div></div>';this._vTracker&&(b.append(c+"y"+d),this._$vScrollBar=b.children(".ui-scrollbar-y")),this._hTracker&&(b.append(c+"x"+d),this._$hScrollBar=b.children(".ui-scrollbar-x"))}}});var g={scrolling:0,overshot:1,snapback:2,done:3};a.extend(f.prototype,{start:function(a,b,c,d,e){this.state=b!=0?a<d||a>e?g.snapback:g.scrolling:g.done,this.pos=a,this.speed=b,this.duration=this.state==g.snapback?this.options.snapbackDuration:c,this.minPos=d,this.maxPos=e,this.fromPos=this.state==g.snapback?this.pos:0,this.toPos=this.state==g.snapback?this.pos<this.minPos?this.minPos:this.maxPos:0,this.startTime=h()},reset:function(){this.state=g.done,this.pos=0,this.speed=0,this.minPos=0,this.maxPos=0,this.duration=0},update:function(){var b=this.state;if(b==g.done)return this.pos;var c=this.duration,d=h()-this.startTime;d=d>c?c:d;if(b==g.scrolling||b==g.overshot){var e=this.speed*(1-a.easing[this.easing](d/c,d,0,1,c)),f=this.pos+e,i=b==g.scrolling&&(f<this.minPos||f>this.maxPos);i&&(f=f<this.minPos?this.minPos:this.maxPos),this.pos=f,b==g.overshot?d>=c&&(this.state=g.snapback,this.fromPos=this.pos,this.toPos=f<this.minPos?this.minPos:this.maxPos,this.duration=this.options.snapbackDuration,this.startTime=h(),d=0):b==g.scrolling&&(i?(this.state=g.overshot,this.speed=e/2,this.duration=this.options.overshootDuration,this.startTime=h()):d>=c&&(this.state=g.done))}else b==g.snapback&&(d>=c?(this.pos=this.toPos,this.state=g.done):this.pos=this.fromPos+(this.toPos-this.fromPos)*a.easing[this.easing](d/c,d,0,1,c));return this.pos},done:function(){return this.state==g.done},getPosition:function(){return this.pos}}),jQuery.widget("mobile.scrolllistview",jQuery.mobile.scrollview,{options:{direction:"y"},_create:function(){a.mobile.scrollview.prototype._create.call(this),this._$dividers=this._$view.find(":jqmData(role='list-divider')"),this._lastDivider=null},_setScrollPosition:function(b,c){a.mobile.scrollview.prototype._setScrollPosition.call(this,b,c),c=-c;var d=this._$dividers,f=d.length,g=null,h=0,i=null;for(var j=0;j<f;j++){i=d.get(j);var k=i.offsetTop;if(c>=k)g=i,h=k;else if(g)break}if(g){var l=g.offsetHeight,m=g!=i?i.offsetTop:this._$view.get(0).offsetHeight;c+l>=m?c=m-l-h:c-=h;var n=this._lastDivider;n&&g!=n&&e(a(n),0,0),e(a(g),0,c+"px"),this._lastDivider=g}}})})(jQuery,window,document);