(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","underscore","./device.partitioner","lib/guardian"],function(b,c,d){var e;return e=function(){function e(){this._reset=a(this._reset,this),this._add_box=a(this._add_box,this),this.generate=a(this.generate,this),this.add_param=a(this.add_param,this),this.add_group=a(this.add_group,this),this.init=a(this.init,this)}return e.prototype._TINT_MAX=12,e.prototype.init=function(){return this._reset()},e.prototype.on_box_add=function(){},e.prototype.on_group_add=function(){},e.prototype.on_ready=function(){},e.prototype.add_group=function(b){return this._device_uid!=null?assert(a(function(){return b.target_uid===this._device_uid},this)):this._device_uid=b.target_uid,b.name.length||(b.name="*"),this._groups[b.name]=this._groups_by_uid[b.uid]=c.extend(b,{params:[]})},e.prototype.add_param=function(a){return this._groups_by_uid[assert(function(){return a!=null?a.target_uid:void 0})].params.push(a)},e.prototype.generate=function(b){var e,f,g,h,i,j;assert(a(function(){return(b!=null?b.uid:void 0)===this._device_uid},this)),g=c.keys(this._groups),h=c.map(c.values(this._groups),function(a){return a.params.length}),f=d.partition(g,h);for(i=0,j=f.length;i<j;i++)e=f[i],c.defer(this._add_box,this._device_uid,this._groups,e,i,i===f.length-1);return this._reset()},e.prototype._add_box=function(d,e,f,g,h){var i,j,k,l,m,n,o;f.device_uid=d,f.group_uids=c.map(f.group_names,a(function(a){return e[a].uid},this)),f.group_tints=c.map(f.group_names,a(function(a,b){return(f.type==="wild"?b:g)%(1+this._TINT_MAX)},this)),f.groups=c.zip(f.group_uids,f.group_names,f.group_tints),f.tint=g,this.on_box_add(f),n=f.groups;for(l=0,m=n.length;l<m;l++)o=n[l],k=o[0],i=o[1],j=o[2],c.defer(this.on_group_add,{group_uid:k,group_params:e[i].params,group_tint:j});if(h)return c.defer(this.on_ready,{$target:b("#"+d+".device")})},e.prototype._reset=function(){return this._device_uid=void 0,this._groups={},this._groups_by_uid={}},e}(),new e})}).call(this);