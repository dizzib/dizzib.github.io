(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","plugin/constants","lib/guardian","css!./gutter"],function(b,c){var d;return d=function(){function d(){this._remove_track=a(this._remove_track,this),this._move_track=a(this._move_track,this),this._expand_track=a(this._expand_track,this),this._collapse_track=a(this._collapse_track,this),this.remove=a(this.remove,this),this.move=a(this.move,this),this.insert=a(this.insert,this),this.collapse=a(this.collapse,this),this.add=a(this.add,this),this.init=a(this.init,this)}return d.prototype.init=function(a){return assert(function(){return a!=null?a.$desk:void 0}).on("safe-tap","#tracks .gutter > .track > .head",{expand:this._expand_track},function(a){var c;return c=b(this).parent(),c.hasClass("disabled")||a.data.expand({$track:c}),!1})},d.prototype.on_add_first=function(){},d.prototype.on_expand=function(){},d.prototype.add=function(a){this._collapse_track(a);if(b("#tracks .gutter").length===1)return this.on_add_first()},d.prototype.collapse=function(a){return this._collapse_track(a)},d.prototype.insert=function(a){return this._collapse_track(a)},d.prototype.move=function(a){return this._move_track(a)},d.prototype.remove=function(a){return this._remove_track(a)},d.prototype.get_width_total=function(){return b("#tracks > .gutter").length*c.CELL_SIZE},d.prototype._create_gutter=function(){return b("<div/>").attr({"class":"gutter"})},d.prototype._collapse_track=function(a){var b,c,d,e;return this._is_in_gutter(assert(function(){return a.$track}))||(e=[a.$track.prevAll(".gutter").first(),a.$track.nextAll(".gutter").first()],c=e[0],b=e[1],c.length===0&&(c=this._create_gutter().prependTo("#tracks")),d=a.$track.prev().hasClass("gutter")?c:b,d.length===0&&(d=b=this._create_gutter().insertAfter(a.$track)),d.append(a.$track),this._merge_adjacent_gutters()),a.$track.removeAttr("style")},d.prototype._expand_track=function(b){var c,d,e;assert(a(function(){return this._is_in_gutter(b.$track)},this)),c=b.$track.parent();if(b.$track.is(".track:first"))b.$track.insertBefore(c),this._is_in_gutter(b.$track.prev())||this._create_gutter().insertBefore(b.$track);else{e=b.$track.nextAll(".track"),b.$track.insertAfter(c);if(e.length>0||!this._is_in_gutter(b.$track.next()))(d=b.$track.next(".gutter")).length===0&&(d=this._create_gutter().insertAfter(b.$track)),d.prepend(e)}return this.on_expand(b),this._trim_side_gutters()},d.prototype._move_track=function(a){var b,c,d;return d=a.target_placement==="Before",this._is_in_gutter(a.$track)?(this._is_in_gutter(a.$target)?d?a.$track.insertBefore(a.$target):a.$track.insertAfter(a.$target):((c=d?a.$target.prev(".gutter"):a.$target.next(".gutter")).length===0&&(assert(function(){return!d}),c=this._create_gutter().insertAfter(a.$target)),d?a.$track.appendTo(c):a.$track.prependTo(c)),this._trim_side_gutters()):(a.$track.detach(),this._merge_adjacent_gutters(),this._is_in_gutter(a.$target)?(d?a.$target.before(a.$track):a.$target.after(a.$track),this._expand_track(a)):(b=this._create_gutter(),d?a.$target.before(a.$track,b):a.$target.after(b,a.$track)))},d.prototype._remove_track=function(a){return this._merge_adjacent_gutters(),this._trim_side_gutters()},d.prototype._trim_side_gutters=function(){var a;(a=b("#tracks > *:first")).hasClass("gutter")&&a.children().length===0&&a.remove();if((a=b("#tracks > *:last")).hasClass("gutter")&&a.children().length===0)return a.remove()},d.prototype._merge_adjacent_gutters=function(){var a,c,d,e,f,g;f=b(".gutter + .gutter"),g=[];for(d=0,e=f.length;d<e;d++)a=f[d],c=b(a).prev(),b(a).prepend(c.children()),g.push(c.remove());return g},d.prototype._is_in_gutter=function(a){return a.parent().hasClass("gutter")},d}(),new d})}).call(this);