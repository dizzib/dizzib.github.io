(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","underscore","lib/datatype.extension/string","lib/guardian","css!./track"],function(b,c){var d;return d=function(){function d(){this._shake=a(this._shake,this),this._expand=a(this._expand,this),this._collapse=a(this._collapse,this),this.is_last=a(this.is_last,this),this.get_xmax=a(this.get_xmax,this),this.get_volumes=a(this.get_volumes,this),this.shake=a(this.shake,this),this.remove=a(this.remove,this),this.move=a(this.move,this),this.insert=a(this.insert,this),this.expand=a(this.expand,this),this.add=a(this.add,this),this.kill=a(this.kill,this),this.init=a(this.init,this)}return d.prototype.init=function(a){return b("<div/>").attr({id:"tracks"}).appendTo(assert(function(){return a!=null?a.$desk:void 0})),a.$desk.on("safe-tap","#tracks > .track > .head",{collapse:this._collapse},function(a){return a.data.collapse({$track:b(this).parent(),is_user:!0}),!1}),this.on_init(a)},d.prototype.kill=function(){return b("#tracks").remove(),this.on_kill()},d.prototype.on_add=function(){},d.prototype.on_collapse=function(){},d.prototype.on_init=function(){},d.prototype.on_insert=function(){},d.prototype.on_kill=function(){},d.prototype.on_move=function(){},d.prototype.on_remove=function(){},d.prototype.on_toggle=function(){},d.prototype.add=function(a){return a.$track=this._create(a).appendTo(b("#tracks")),this.on_add(a)},d.prototype.expand=function(a){return this._expand(a)},d.prototype.insert=function(a){var c,d;return d=[this._create(a),b("#"+a.target_uid)],a.$track=d[0],c=d[1],a.target_placement==="Before"?a.$track.insertBefore(c):a.$track.insertAfter(c),this.on_insert(a)},d.prototype.move=function(a){var c;return c=[b("#"+a.uid),b("#"+a.target_uid)],a.$track=c[0],a.$target=c[1],this.on_move(a)},d.prototype.remove=function(c){var d;return d=assert(function(){return b("#"+c.uid+".track")}),d.fadeOut(a(function(){return this.on_remove(c),d.remove()},this))},d.prototype.rename=function(a){return b("#"+a.uid+" h1").html(a.name.fracture())},d.prototype.shake=function(a){return this._shake(a)},d.prototype.get_last=function(){return b(".track:last","#tracks")},d.prototype.get_volumes=function(){return this._get_volumes()},d.prototype.get_width=function(){return b("#tracks").width()},d.prototype.get_width_total=function(){return c.reduce(b("#tracks > .track"),function(a,c){return a+b(c).outerWidth(!0)},0)},d.prototype.get_xmax=function(){var a;return a=this.get_last(),a.pos().x+a.width()},d.prototype.get_ymax=function(){return c.max(c.map(b(".gutter>.track>.head, .track>.foot","#tracks"),function(a){return b(a).pos().y+b(a).height()}))},d.prototype.is_last=function(a){return a.attr("id")===this.get_last().attr("id")},d.prototype.set_width=function(a){return b("#tracks").width(assert(function(){return a!=null?a.width_tracks:void 0}))},d.prototype._create=function(a){var c,d,e,f,g;return g=b("<div/>").attr({id:a.uid,"class":"track disabled"}),e=b("<div/>").attr({"class":"head"}),f=b("<h1/>").html(a.name.fracture()).appendTo(e),c=b("<div/>").attr({"class":"body"}),d=b("<div/>").attr({"class":"foot"}),g.append(e).append(c).append(d)},d.prototype._collapse=function(a){this.on_collapse(a),this.on_toggle(c.extend(a,{is_collapse:!0}));if(a.is_user)return b("h1",a.$track).indicate()},d.prototype._expand=function(a){return this.on_toggle(c.extend(a,{is_expand:!0})),b("h1",a.$track).indicate()},d.prototype._get_volumes=function(){var a,c,d,e,f,g,h,i,j,k,l;j=[[],0],g=j[0],e=j[1],k=b("#tracks > .track");for(h=0,i=k.length;h<i;h++)d=k[h],a=b(".device:not(.hidden)",c=b(d)),f=b(".box:not(.hidden) .cell:not(.hidden), .box.tame",a).length,g.push([c,f]),e+=f;return l=[g,e],g=l[0],e=l[1],l},d.prototype._shake=function(a){var c;c=assert(function(){return b("#"+a.uid+".device").parents(".track")});if(a.target_uid!=null)return c.removeClass("disabled");if(b(".device",c).length===1)return c.addClass("disabled"),this._collapse({$track:c,is_user:!1})},d}(),new d})}).call(this);